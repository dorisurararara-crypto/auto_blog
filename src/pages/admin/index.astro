---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const auth = Astro.url.searchParams.get('pw');
if (auth !== '1234') {
    return new Response('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', { status: 403 });
}

const db = Astro.locals.runtime.env.DB;

// 1. ì „ì²´ ìš”ì•½ í†µê³„
const totalVisits = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'visit'").first('count');
const coupangClicks = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'click'").first('count');

// 2. ê°œë³„ ê¸€ë³„ ìƒì„¸ í†µê³„ (ì¡°íšŒìˆ˜ ë†’ì€ ìˆœ)
const postStats = await db.prepare(`
    SELECT 
        path, 
        COUNT(CASE WHEN type = 'visit' THEN 1 END) as visits,
        COUNT(CASE WHEN type = 'click' THEN 1 END) as clicks
    FROM stats 
    WHERE path LIKE '/blog/%' OR path LIKE '/manual/%'
    GROUP BY path 
    ORDER BY visits DESC
`).all();
---

<Layout title="GTB ë§¤ê±°ì§„ - í†µí•© ê´€ë¦¬ì">
	<div class="admin-dashboard">
		<header class="admin-header">
			<h1>ğŸ‘‘ GTB ë§¤ê±°ì§„ ë°ì´í„° ì„¼í„°</h1>
			<p>ì–´ë–¤ ê¸€ì´ ì¸ê¸°ê°€ ë§ì€ì§€ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.</p>
		</header>

		<!-- ìƒë‹¨ ìš”ì•½ í†µê³„ -->
		<section class="stat-grid">
			<div class="stat-card">
				<span class="label">ëˆ„ì  ì´ ë°©ë¬¸</span>
				<span class="value">{totalVisits}</span>
			</div>
			<div class="stat-card">
				<span class="label">ëˆ„ì  ì¿ íŒ¡ í´ë¦­</span>
				<span class="value">{coupangClicks}</span>
			</div>
		</section>

		<!-- ê¸€ë³„ ìƒì„¸ í†µê³„ ì„¹ì…˜ -->
		<section class="admin-section">
			<h2>ğŸ“Š ì½˜í…ì¸ ë³„ ì„±ê³¼ ë¦¬í¬íŠ¸</h2>
			<div class="stats-table-wrapper">
				<table class="stats-table">
					<thead>
						<tr>
							<th>ì½˜í…ì¸  ê²½ë¡œ</th>
							<th>ì¡°íšŒìˆ˜</th>
							<th>ì¿ íŒ¡ í´ë¦­</th>
							<th>í´ë¦­ë¥ (CTR)</th>
						</tr>
					</thead>
					<tbody>
						{postStats.results.map((stat) => (
							<tr>
								<td class="path-cell"><a href={stat.path} target="_blank">{stat.path}</a></td>
								<td class="num-cell">{stat.visits}íšŒ</td>
								<td class="num-cell">{stat.clicks}íšŒ</td>
								<td class="num-cell">
									{stat.visits > 0 ? ((stat.clicks / stat.visits) * 100).toFixed(1) : 0}%
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</section>
	</div>
</Layout>

<style>
	.admin-dashboard { max-width: 1000px; margin: 0 auto; padding: 3rem 0; }
	.admin-header { text-align: center; margin-bottom: 4rem; }
	.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 3rem; }
	.stat-card { background: white; padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
	.stat-card .label { display: block; color: #64748b; font-weight: 600; margin-bottom: 0.5rem; }
	.stat-card .value { font-size: 3rem; font-weight: 900; color: #2563eb; }
	
	.admin-section { background: white; padding: 2rem; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
	.admin-section h2 { margin-bottom: 1.5rem; font-size: 1.25rem; }

	.stats-table-wrapper { overflow-x: auto; }
	.stats-table { width: 100%; border-collapse: collapse; text-align: left; }
	.stats-table th { padding: 1rem; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 0.9rem; }
	.stats-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
	.path-cell { font-family: monospace; font-size: 0.9rem; max-width: 400px; overflow: hidden; text-overflow: ellipsis; }
	.path-cell a { color: #2563eb; text-decoration: none; }
	.path-cell a:hover { text-decoration: underline; }
	.num-cell { font-weight: 600; text-align: right; }
</style>