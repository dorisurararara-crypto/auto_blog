---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const auth = Astro.url.searchParams.get('pw');
if (auth !== '1234') {
    return new Response('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', { status: 403 });
}

const db = Astro.locals.runtime.env.DB;

// 1. ì „ì²´ ìš”ì•½ í†µê³„
const totalVisitsResult = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'visit'").first();
const totalVisits = totalVisitsResult ? totalVisitsResult.count : 0;

const coupangClicksResult = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'click'").first();
const coupangClicks = coupangClicksResult ? coupangClicksResult.count : 0;

// 2. ê°œë³„ ê¸€ë³„ ìƒì„¸ í†µê³„ ë° ê´€ë¦¬ ê¸°ëŠ¥
const postStatsResult = await db.prepare(`
    SELECT 
        p.id,
        p.slug,
        p.title,
        p.category,
        p.created_at,
        COUNT(CASE WHEN s.type = 'visit' THEN 1 END) as visits,
        COUNT(CASE WHEN s.type = 'click' THEN 1 END) as clicks
    FROM posts p
    LEFT JOIN stats s ON s.path = '/blog/' || p.slug
    GROUP BY p.id
    ORDER BY p.created_at DESC
`).all();

const posts = postStatsResult.results || [];
---

<Layout title="GTB ë§¤ê±°ì§„ - í†µí•© ê´€ë¦¬">
	<div class="admin-dashboard">
		<header class="admin-header">
			<h1>ğŸ‘‘ GTB ë§¤ê±°ì§„ ì½˜í…ì¸  ì„¼í„°</h1>
			<p>ë°ì´í„° í™•ì¸ ë° í¬ìŠ¤íŒ… ê´€ë¦¬ë¥¼ í•œ ê³³ì—ì„œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
		</header>

		<!-- ìƒë‹¨ ìš”ì•½ í†µê³„ -->
		<section class="stat-grid">
			<div class="stat-card">
				<span class="label">ëˆ„ì  ì´ ë°©ë¬¸</span>
				<span class="value">{totalVisits}</span>
			</div>
			<div class="stat-card">
				<span class="label">ëˆ„ì  ì¿ íŒ¡ í´ë¦­</span>
				<span class="value">{coupangClicks}</span>
			</div>
		</section>

		<!-- ê¸€ë³„ ìƒì„¸ í†µê³„ ë° ê´€ë¦¬ ì„¹ì…˜ -->
		<section class="admin-section">
			<h2>ğŸ“‚ ì „ì²´ ì½˜í…ì¸  ê´€ë¦¬ ({posts.length}ê°œ)</h2>
			<div class="stats-table-wrapper">
				<table class="stats-table">
					<thead>
						<tr>
							<th>ì œëª© / ì¹´í…Œê³ ë¦¬</th>
							<th>ì¡°íšŒìˆ˜</th>
							<th>í´ë¦­(CTR)</th>
							<th>ì‘ì„±ì¼</th>
							<th>ê´€ë¦¬</th>
						</tr>
					</thead>
					<tbody>
						{posts.map((post) => (
							<tr>
								<td class="info-cell">
									<a href={`/blog/${post.slug}`} target="_blank" class="post-title">{post.title}</a>
									<span class="post-category">{post.category}</span>
								</td>
								<td class="num-cell">{post.visits || 0}íšŒ</td>
								<td class="num-cell">
									{post.visits > 0 ? (((post.clicks || 0) / post.visits) * 100).toFixed(1) : 0}%
								</td>
								<td class="date-cell">{post.created_at ? post.created_at.split(' ')[0] : '-'}</td>
								<td class="action-cell">
									<button class="btn-delete" onclick={`deletePost(${post.id})`}>ì‚­ì œ</button>
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</section>
	</div>

	<script is:inline>
		async function deletePost(id) {
			if (!confirm('ì´ ê¸€ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€ëŠ¥)')) return;
			
			const res = await fetch('/api/posts', {
				method: 'DELETE',
				body: JSON.stringify({ id }),
				headers: { 'Content-Type': 'application/json' }
			});

			if (res.ok) {
				alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
				location.reload();
			} else {
				alert('ì‚­ì œ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
			}
		}
	</script>
</Layout>

<style>
	.admin-dashboard { max-width: 1100px; margin: 0 auto; padding: 3rem 0; }
	.admin-header { text-align: center; margin-bottom: 4rem; }
	.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 3rem; }
	.stat-card { background: white; padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
	.stat-card .label { display: block; color: #64748b; font-weight: 600; margin-bottom: 0.5rem; }
	.stat-card .value { font-size: 3rem; font-weight: 900; color: #2563eb; }
	
	.admin-section { background: white; padding: 2rem; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
	.admin-section h2 { margin-bottom: 1.5rem; font-size: 1.25rem; }

	.stats-table-wrapper { overflow-x: auto; }
	.stats-table { width: 100%; border-collapse: collapse; text-align: left; }
	.stats-table th { padding: 1rem; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
	.stats-table td { padding: 1.2rem 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
	
	.info-cell { max-width: 350px; }
	.post-title { display: block; font-weight: 700; color: #1e293b; text-decoration: none; margin-bottom: 0.25rem; line-height: 1.4; }
	.post-title:hover { color: #2563eb; }
	.post-category { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 0.1rem 0.5rem; border-radius: 4px; }
	
	.num-cell { font-weight: 600; text-align: center; font-variant-numeric: tabular-nums; }
	.date-cell { font-size: 0.85rem; color: #64748b; white-space: nowrap; }
	.btn-delete { background: #fee2e2; color: #dc2626; border: none; padding: 0.5rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
	.btn-delete:hover { background: #fecaca; }
</style>