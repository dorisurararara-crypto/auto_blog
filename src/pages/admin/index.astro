---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const auth = Astro.url.searchParams.get('pw');
if (auth !== '1234') {
    return new Response('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', { status: 403 });
}

const db = Astro.locals.runtime.env.DB;

// 1. í†µê³„ ë°ì´í„°
const totalVisits = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'visit'").first('count');
const coupangClicks = await db.prepare("SELECT COUNT(*) as count FROM stats WHERE type = 'click'").first('count');

// 2. ì§ì ‘ ì‘ì„±í•œ ê¸€ ëª©ë¡ (CRUDìš©)
const manualPosts = await db.prepare("SELECT * FROM manual_posts ORDER BY created_at DESC").all();
---

<Layout title="GTB ë§¤ê±°ì§„ - í†µí•© ê´€ë¦¬ì">
	<div class="admin-dashboard">
		<header class="admin-header">
			<h1>ğŸ‘‘ GTB ë§¤ê±°ì§„ í†µí•© ì»¨íŠ¸ë¡¤ëŸ¬</h1>
			<p>í†µê³„ í™•ì¸ë¶€í„° ê¸€ ì‘ì„±ê¹Œì§€ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.</p>
		</header>

		<!-- ìƒë‹¨ ìš”ì•½ í†µê³„ -->
		<section class="stat-grid">
			<div class="stat-card">
				<span class="label">ì´ ë°©ë¬¸ì</span>
				<span class="value">{totalVisits}</span>
			</div>
			<div class="stat-card">
				<span class="label">ì¿ íŒ¡ í´ë¦­</span>
				<span class="value">{coupangClicks}</span>
			</div>
		</section>

		<!-- ê¸€ ì‘ì„± ì„¹ì…˜ (Create) -->
		<section class="admin-section">
			<div class="section-header">
				<h2>ğŸ“ ì§ì ‘ ê¸€ì“°ê¸°</h2>
			</div>
			<form id="postForm" class="post-form">
				<input type="text" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required />
				<input type="text" name="category" placeholder="ì¹´í…Œê³ ë¦¬ (ITí…Œí¬, ê±´ê°•, ë¼ì´í”„)" required />
				<input type="text" name="imageUrl" placeholder="ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL" />
				<textarea name="summary" placeholder="ì§§ì€ ìš”ì•½ ë¬¸êµ¬"></textarea>
				<textarea name="content" placeholder="ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ë§ˆí¬ë‹¤ìš´ ì§€ì›)" class="content-area" required></textarea>
				<button type="submit" class="btn-primary">í¬ìŠ¤íŒ… ë°œí–‰í•˜ê¸°</button>
			</form>
		</section>

		<!-- ê¸€ ëª©ë¡ ì„¹ì…˜ (Read/Delete) -->
		<section class="admin-section">
			<h2>ğŸ“‚ ë‚´ê°€ ì“´ ê¸€ ê´€ë¦¬</h2>
			<div class="post-list">
				{manualPosts.results.map((post) => (
					<div class="post-item">
						<div class="post-info">
							<strong>{post.title}</strong>
							<span>{post.category} | {post.created_at}</span>
						</div>
						<div class="post-actions">
							<button class="btn-delete" onclick={`deletePost(${post.id})`}>ì‚­ì œ</button>
						</div>
					</div>
				))}
			</div>
		</section>
	</div>

	<script is:inline>
		// ê¸€ ì‘ì„± í•¸ë“¤ëŸ¬
		document.getElementById('postForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(e.target);
			const data = Object.fromEntries(formData);

			const res = await fetch('/api/posts', {
				method: 'POST',
				body: JSON.stringify(data),
				headers: { 'Content-Type': 'application/json' }
			});

			if (res.ok) {
				alert('ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
				location.reload();
			} else {
				alert('ë°œí–‰ ì‹¤íŒ¨!');
			}
		});

		// ê¸€ ì‚­ì œ í•¸ë“¤ëŸ¬
		async function deletePost(id) {
			if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
			
			const res = await fetch('/api/posts', {
				method: 'DELETE',
				body: JSON.stringify({ id }),
				headers: { 'Content-Type': 'application/json' }
			});

			if (res.ok) {
				location.reload();
			}
		}
	</script>
</Layout>

<style>
	.admin-dashboard { max-width: 900px; margin: 0 auto; padding: 3rem 0; }
	.admin-header { text-align: center; margin-bottom: 4rem; }
	.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 3rem; }
	.stat-card { background: #f8fafc; padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
	.stat-card .value { font-size: 2.5rem; font-weight: 800; color: #2563eb; }
	
	.admin-section { background: white; padding: 2rem; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 3rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
	.post-form { display: flex; flex-direction: column; gap: 1rem; }
	.post-form input, .post-form textarea { padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; }
	.content-area { min-height: 300px; }
	.btn-primary { background: #2563eb; color: white; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
	
	.post-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f1f5f9; }
	.post-info { display: flex; flex-direction: column; }
	.post-info span { font-size: 0.85rem; color: #64748b; }
	.btn-delete { background: #fee2e2; color: #dc2626; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
</style>