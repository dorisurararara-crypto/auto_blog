---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const { category } = Astro.params;
const db = Astro.locals.runtime.env.DB;

// DB에서 해당 카테고리의 글들 가져오기
let posts = [];
try {
	const { results } = await db.prepare("SELECT * FROM posts WHERE category = ? ORDER BY created_at DESC").bind(category).all();
	posts = results.map(p => ({
		slug: p.slug,
		title: p.title,
		summary: p.summary,
		image: p.image_url,
		date: p.created_at ? p.created_at.split(' ')[0].replace(/-/g, '. ') : ''
	}));
} catch (e) {
	console.error("카테고리 글 로드 실패:", e);
}
---

<Layout title={`${category} - GTB 매거진`}>
	<div class="category-header">
		<div class="container">
			<h2>{category}</h2>
			<p>총 {posts.length}개의 이야기가 있습니다.</p>
		</div>
	</div>

	<div class="container">
		<div class="grid">
			{posts.map((post) => (
				<article class="card">
					<a href={`/blog/${post.slug}`}>
						<div class="card-image">
							{post.image && <img src={post.image} alt={post.title} loading="lazy" />}
						</div>
						<div class="card-content">
							<h3>{post.title}</h3>
							<p class="summary">{post.summary}</p>
							<div class="card-footer">
								<span class="date">{post.date}</span>
							</div>
						</div>
					</a>
				</article>
			))}
		</div>
	</div>
</Layout>

<style>
	.category-header { background: #f9fafb; padding: 4rem 0; text-align: center; margin-bottom: 3rem; }
	.category-header h2 { font-size: 2.5rem; margin: 0; }
	.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
	.card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #f3f4f6; }
	.card-image { aspect-ratio: 16/9; overflow: hidden; }
	.card-image img { width: 100%; height: 100%; object-fit: cover; }
	.card-content { padding: 1.5rem; }
	.summary { font-size: 0.95rem; color: #4b5563; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
</style>
