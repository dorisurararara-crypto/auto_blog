---
import Layout from '../layouts/Layout.astro';

// DBì—ì„œ ì¡°íšŒìˆ˜ ìˆœìœ¼ë¡œ ì¸ê¸°ê¸€ 10ê°œ ê°€ì ¸ì˜¤ê¸°
let popularPosts = [];
try {
	const db = Astro.locals.runtime.env.DB;
	const { results } = await db.prepare(`
		SELECT 
			p.*, 
			COUNT(s.id) as visits 
		FROM posts p
		LEFT JOIN stats s ON s.path = '/blog/' || p.slug AND s.type = 'visit'
		GROUP BY p.id
		ORDER BY visits DESC
		LIMIT 10
	`).all();
	
	popularPosts = results.map(p => ({
		id: p.id,
		slug: `/blog/${p.slug}`,
		title: p.title,
		summary: p.summary,
		image: p.image_url || '/images/default-post.png',
		date: p.created_at ? p.created_at.split(' ')[0].replace(/-/g, '. ') : '',
		category: p.category || 'ì¸ì‚¬ì´íŠ¸',
		visits: p.visits
	}));
} catch (e) {
	console.error("ì¸ê¸°ê¸€ ë¡œë“œ ì‹¤íŒ¨:", e);
}
---

<Layout title="ì¸ê¸°ê¸€ TOP 10 - GTB ë§¤ê±°ì§„">
	<div class="category-header">
		<div class="container">
			<h2>ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸°ê¸€ TOP 10</h2>
			<p>ê°€ì¥ ë§ì€ ë…ìë“¤ì´ ì„ íƒí•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”.</p>
		</div>
	</div>

	<div class="container">
		<div class="popular-list">
			{popularPosts.map((post, index) => (
				<article class="popular-card">
					<span class="rank-badge">{index + 1}</span>
					<a href={post.slug} class="card-link">
						<div class="card-image">
							<img src={post.image} alt={post.title} loading="lazy" />
						</div>
						<div class="card-content">
							<span class="category">{post.category}</span>
							<h3>{post.title}</h3>
							<p class="summary">{post.summary}</p>
							<div class="card-footer">
								<span>{post.date}</span>
								<span class="visit-count">ì¡°íšŒìˆ˜ {post.visits}íšŒ</span>
							</div>
						</div>
					</a>
				</article>
			))}
		</div>
	</div>
</Layout>

<style>
	.category-header { background: #fff; padding: 3rem 0; text-align: center; border-bottom: 1px solid #f1f5f9; margin-bottom: 2rem; }
	.category-header h2 { font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 0.5rem; }
	.category-header p { color: #64748b; font-size: 1rem; }
	
	.popular-list { display: flex; flex-direction: column; gap: 1.5rem; max-width: 800px; margin: 0 auto; }
	.popular-card { position: relative; background: white; transition: all 0.3s ease; }
	
	.rank-badge { position: absolute; top: 10px; left: 10px; width: 32px; height: 32px; background: #2563eb; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1rem; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
	
	.card-link { display: flex; flex-direction: column; text-decoration: none; color: inherit; overflow: hidden; gap: 1rem; }
	.card-image { width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; }
	.card-image img { width: 100%; height: 100%; object-fit: cover; }
	.card-content { flex: 1; display: flex; flex-direction: column; }
	
	.category { font-size: 0.8rem; color: #2563eb; font-weight: 800; margin-bottom: 0.4rem; background: #eff6ff; padding: 0.1rem 0.5rem; border-radius: 4px; align-self: flex-start; }
	h3 { font-size: 1.25rem; margin-bottom: 0.6rem; font-weight: 800; line-height: 1.4; color: #1e293b; letter-spacing: -0.5px; }
	.summary { font-size: 0.95rem; color: #64748b; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 0.75rem; }
	.card-footer { display: flex; justify-content: space-between; font-size: 0.85rem; color: #94a3b8; font-weight: 500; }
	.visit-count { font-weight: 700; color: #2563eb; }

	@media (min-width: 640px) {
		.card-link { flex-direction: row; align-items: flex-start; gap: 1.5rem; }
		.card-image { width: 240px; min-width: 240px; }
		.rank-badge { top: -8px; left: -8px; }
	}
</style>
